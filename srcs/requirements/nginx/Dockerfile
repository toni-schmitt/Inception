FROM debian:buster

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update
# Install dumb-init for handling PID 0 and Zombie Proccesses
RUN apt-get install -y --quiet \
		dumb-init
# Install nginx and openssl for the webserver and certificates
RUN apt-get install -y --quiet --no-install-recommends --no-install-suggests \
		nginx \
		openssl
# Remove all non needed packages and tmp directory
RUN apt-get remove --purge --auto-remove -y --quiet
RUN rm -rf /tmp/* /var/tmp/*

# Generate self-signed TLS Certificate
RUN mkdir -p /etc/nginx/certs
RUN openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \
		# '-subj' for non interactive creation
		-subj "/C=DE/ST=BW/L=Heilbronn/O=42 Heilbronn/CN=www.example.com" \
		-keyout /etc/nginx/certs/cert.key -out /etc/nginx/certs/cert.crt

# Copy nginx.conf to Container
COPY nginx.conf /etc/nginx/sites-available/default

# Expose Port 443 (https?)
EXPOSE 443

# Use dumb-init as Entrypoint
ENTRYPOINT ["/usr/bin/dumb-init", "--"]

# Start the nginx service
CMD ["/usr/sbin/nginx", "-g", "daemon off;"]
